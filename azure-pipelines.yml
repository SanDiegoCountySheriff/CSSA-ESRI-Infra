# azure-pipelines.yml | San Marcos GIS on Azure
#
# Copyright (C) 2023 City of San Marcos CA
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

trigger:
  - development/nsg-refactor-steps
  
pool:
    vmImage: ubuntu-latest
  
  #pool:
  #  name: 'On-Premises'

variables:
  DeploymentDefaultLocation: 'westus'
  System.Debug: true
  ResourceGroupName: 'rg-cosm-gis-devtest'

stages:
  - stage: Vnet
    jobs:
      - job: DeployVnet
        steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              #deploymentScope: 'Subscription'
              subscriptionId: $(SubscriptionId)
              connectedServiceName: $(ServiceConnectionName)
              location: $(DeploymentDefaultLocation)
              resourceGroupName: $(ResourceGroupName)
              csmFile: ./stages/vnet/main.bicep
              #deploymentMode: 'Complete'
              overrideParameters: >
                -location "$(DeploymentDefaultLocation)" 
                -environmentType "$(EnvironmentType)" 
                -networkConnectionSharedKey '$(networkConnectionSharedKey)'
  - stage: Nsg
    jobs:
      - job: DeployNsg
        steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              #deploymentScope: 'Subscription'
              subscriptionId: $(SubscriptionId)
              connectedServiceName: $(ServiceConnectionName)
              location: $(DeploymentDefaultLocation)
              resourceGroupName: $(ResourceGroupName)
              csmFile: ./stages/nsg/main.bicep
              #deploymentMode: 'Complete'
              overrideParameters: >
                -location "$(DeploymentDefaultLocation)" 
                -environmentType "$(EnvironmentType)" 